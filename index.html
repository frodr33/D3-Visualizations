<head>
    {{/* <script src="https://unpkg.com/d3-array@1"></script>
    <script src="https://unpkg.com/d3-collection@1"></script>
    <script src="https://unpkg.com/d3-path@1"></script>
    <script src="https://unpkg.com/d3-shape@1"></script>
    <script src="https://unpkg.com/d3-sankey@0"></script>
    <script src="https://d3js.org/d3.v5.min.js"></script> */}}
    <script src="//d3js.org/d3-scale-chromatic.v0.3.min.js"></script>
</head>

<body>
  <style>
    .center {
      text-align: center;
      font-family: Verdana;
    }

    .vis {
      display: inline-block;
    }

    /* .line {
          stroke: gray;
      } */
    .gridlines line {
      stroke: gray;
    }

    .gridlines .domain {
      stroke: none;
    }
  </style>

  <h2 class="center">U.S. Graduate Admissions</h2>

  <div class="vis" id="vis1" style="text-align:center;">
  </div>

  <div class="vis" id="vis2">
  </div>

  <script>
    const requestData = async () => {
      let universityData = await d3.csv("datasets/admissions.csv");
      const WIDTH = 800;
      const HEIGHT = 600;
      const margin = { top: 20, left: 20, bottom: 20, right: 20 };
      const chartWidth = WIDTH - margin.left - margin.right;
      const chartHeight = HEIGHT - margin.top - margin.bottom;

      // Cast string values to numbers
      universityData.forEach(d => {
        Object.keys(d).forEach(field => {
          d[field] = Number(d[field])
        });
      });

      const TOEFLmin = d3.min(universityData, d => d['TOEFL Score']);
      const TOEFLmax = d3.max(universityData, d => d['TOEFL Score']);
      const GREmin = d3.min(universityData, d => d['GRE Score']);
      const GREmax = d3.max(universityData, d => d['GRE Score']);
      const admitMin = d3.min(universityData, d => d['Chance of Admit']);
      const admitMax = d3.max(universityData, d => d['Chance of Admit']);
      const CGPAmin = d3.min(universityData, d => d['CGPA']);
      const CGPAmax = d3.max(universityData, d => d['CGPA']);
      console.log(admitMin, admitMax);
      console.log(universityData);
      console.log(TOEFLmin, TOEFLmax);
      console.log(CGPAmin, CGPAmax);

      // Set up svgs...we could add a third one?
      testScores = d3.select('div#vis1').append("svg")
        .attr("width", WIDTH)
        .attr("height", HEIGHT)
        .attr("id", "svgTestScores");

      admissionChance = d3.select('div#vis2').append("svg")
        .attr("width", 1300)
        .attr("height", 1300)
        .attr("id", "svgAdmissions")

      // axes
      let xScale = d3.scaleLinear()
        .domain([TOEFLmin - 2, TOEFLmax])
        .range([margin.left, WIDTH - margin.right])

      let yScale = d3.scaleLinear()
        .domain([GREmin - 5, GREmax + 5])
        .range([HEIGHT - margin.top, margin.bottom]);

      let rScale = d3.scaleLog()
        .domain([admitMin, admitMax])
        .range([1, 12]);

      let colorScale = d3.scaleSequential(d3.interpolatePlasma)
        .domain([CGPAmin,CGPAmax])

      // axes and gridlines
      let xAxis = d3.axisLeft(yScale).tickSize(-chartWidth).tickFormat("").ticks(12);
      testScores.append("g").attr("class", "y gridlines")
        .attr("transform", "translate(30,0)")
        .call(xAxis);

      let yAxis = d3.axisBottom(xScale).tickSize(-chartHeight).tickFormat("").ticks(12);
      testScores.append("g")
        .attr("transform", "translate(10," + yScale(GREmin - 5) + ")")
        .attr("class", "x gridlines")
        .call(yAxis);

      testScores.append("g")
        .attr("transform", "translate(10," + yScale(GREmin - 5) + ")")
        .attr("class", "axis")
        .call(d3.axisBottom(xScale).ticks(12));

      testScores.append("g")
        .attr("transform", "translate(30,0)")
        .attr("class", "axis")
        .call(d3.axisLeft(yScale).ticks(12));

      universityData.forEach((d, i) => {
        circle = testScores.append("circle")
          .attr("cx", xScale(d["TOEFL Score"]))
          .attr("cy", yScale(d["GRE Score"]))
          .attr("r", rScale(d['Chance of Admit']))
          .style("fill", colorScale(d["CGPA"])) // change this too
          .attr("opacity", 0.5)
      });


      ////////////////////////////////////////
      /////////////    svg2    ///////////////
      ////////////////////////////////////////

      var cornellData = await d3.csv("datasets/cornellAdmissions.csv");

      cornellData.forEach((d) => {
          if (d["Accepted"] != "Rejected" && d["Accepted"] != "Accepted"){
              d["Accepted"] = "Rejected" 
          }
          d["GPA"] = Number(d["GPA"]);
          d["GRE_Verbal"] = Number(d["GRE_Verbal"]);
          d["GRE_Quant"] = Number(d["GRE_Quant"]);
          d["GRE_Writing"] = Number(d["GRE_Writing"]);
      });

      const nodeNames = [
          "Cornell", 
          "Yale", 
          "Berkeley", 
          "High GPA",
          "Average GPA",
          "Low GPA",
          "High GRE Verbal",
          "Average GRE Verbal",
          "Low GRE Verbal",
          "High GRE Quant",
          "Average GRE Quant",
          "Low GRE Quant",
          "High GRE Writing",
          "Average GRE Writing",
          "Low GRE Writing",
          "Accepted",
          "Rejected",
          ];

      let indexMapping = new Map(nodeNames.map((d,i) => [d,i]));
      let nodes = [];
      nodeNames.forEach((nodeName) => {
          nodes.push({name:nodeName});
      })

      let links = [];
      cornellData.forEach((d) => {
          var school = d["College"]
          var gpa = d["GPA"];
          var gpaStatus; // Could make scale for this
          var greVerbalScore = d["GRE_Verbal"]
          var greVerbalStatus;
          var greQuantScore = d["GRE_Quant"]
          var greQuantStatus;
          var greWritingScore = d["GRE_Writing"]
          var greWritingStatus;


          // Can make this cleaner later
          if (gpa > 3.5) {
              gpaStatus = "High GPA"
          } else if (gpa > 3.0 && gpa <= 3.5) {
              gpaStatus = "Average GPA";
          } else {
              gpaStatus = "Low GPA"
          }
          
          if (greQuantScore > 158.0) {
              greQuantStatus = "High GRE Verbal";
          } else if (greQuantScore > 151.0 && greQuantScore <= 158.0) {
              greQuantStatus = "Average GRE Verbal";
          } else {
              greQuantStatus = "Low GRE Verbal"
          }

          if (greVerbalScore > 158.0) {
              greVerbalStatus = "High GRE Quant";
          } else if (greVerbalScore > 151.0 && greVerbalScore <= 158.0) {
              greVerbalStatus = "Average GRE Quant";
          } else {
              greVerbalStatus = "Low GRE Quant"
          }

          if (greWritingScore > 4.5) {
              greWritingStatus = "High GRE Writing";
          } else if (greWritingScore > 4 && greWritingScore <= 4.5) {
              greWritingStatus = "Average GRE Writing";
          } else {
              greWritingStatus = "Low GRE Writing"
          }

          links.push({
              source: indexMapping.get(school),
              target: indexMapping.get(gpaStatus),
              school: school,
              value: 1
          },{
              source: indexMapping.get(gpaStatus),
              target: indexMapping.get(greVerbalStatus),
              school: school,
              value: 1
          },
          {
              source: indexMapping.get(greVerbalStatus),
              target: indexMapping.get(greQuantStatus),
              school: school,
              value: 1              
          },
          {
              source: indexMapping.get(greQuantStatus),
              target: indexMapping.get(greWritingStatus),
              school: school,
              value: 1
          },{
              source: indexMapping.get(greWritingStatus),
              target: indexMapping.get(d["Accepted"]),
              school: school,
              value: 1
          });
      });

    

      {{/* var links = []
      var m = new Map();
      rawLinks.forEach((d) => {
        var key = d.source+d.target+d.school;
        var val = m.get(key)
        if (val == null){
          m.set((key),{
            value: 1,
            school: d.school,
            source: d.source,
            target: d.target
          })
        } 
      })
      let allPossibleLinks = [...m.keys()]
      allPossibleLinks.forEach((key) => {
        var obj = m.get(key);
        links.push({
            source: obj.source,
            target: obj.target,
            school: obj.school,
            value: obj.value         
        })
      }) */}}


      const sankey = d3.sankey()
        .nodeWidth(15)
        .nodePadding(10)
        .extent([[1, 30], [1200 - 1, 600 - 5]]);
      
      console.log(nodes)
      console.log(links)

      graph = sankey({nodes, links})

      console.log(graph.links);
      admissionChance.append("g")
        .attr("stroke","#000")
        .selectAll("rect")
        .data(graph.nodes)
        .join("rect")
        .attr("x", d => d.x0)
        .attr("y", d => d.y0)
        .attr("height", d => (d.y1 - d.y0))
        .attr("width", d => d.x1 - d.x0)
        .append("title")
            .text(d => d.name)

      admissionChance.append("g")
          .attr("fill", "none")
          .attr("stroke-opacity", .6)
        .selectAll("path")
        .data(graph.links)
        .join("path")
        .attr("stroke","green")
          .attr("d", d3.sankeyLinkHorizontal())

          {{/* .attr("stroke", d => 
              d.school === "Cornell" ? "Red"
                : d.school ==="Berkeley" ? "Yellow"
                : "Blue") */}}

     sankey.update(graph);

     admissionChance.append("g")
      .style("font", "10px sans-serif")
      .selectAll("text")
      .data(nodes)
      .join("text")
      .attr("x", d => d.x0 < WIDTH / 2 ? d.x1 + 6 : d.x0 - 6)
      .attr("y", d => (d.y1 + d.y0) / 2)
      .attr("text-anchor", d => d.x0 < WIDTH / 2 ? "start" : "end")
      .text(d => d.name);
    }

    { {/* columns: (9) ["Serial No.", "GRE Score", "TOEFL Score", "University Rating", "SOP", "LOR ", "CGPA", "Research", "Chance of Admit "] */ } }
    requestData();
  </script>
</body>
