<head>
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <script src="https://unpkg.com/d3-array@1"></script>
  <script src="https://unpkg.com/d3-collection@1"></script>
  <script src="https://unpkg.com/d3-path@1"></script>
  <script src="https://unpkg.com/d3-shape@1"></script>
  <script src="https://unpkg.com/d3-sankey@0"></script>
</head>

<body>
  <style>
    body {
      font-family: 'Trebuchet MS', 'Lucida Sans Unicode', 'Lucida Grande', 'Lucida Sans', Arial, sans-serif;
      background-color: rgb(183, 167, 231);
    }

    h1#about {
      text-align: center;
      margin-bottom: 5px;
    }

    p {
      display: block;
      padding-right: 750px;
    }

    div#vis1 {
      text-align: center;
      text-anchor: middle;
      display: block;
    }

    .gridlines line {
      stroke: #504E48;
      stroke-width: 0.5;
    }

    .gridlines .domain {
      stroke: none;
    }

    .node rect {
      cursor: move;
      fill-opacity: .9;
      shape-rendering: crispEdges;
    }

    .node text {
      pointer-events: none;
      text-shadow: 0 1px 0 #fff;
    }

    .link {
      fill: none;
      stroke: #000;
      stroke-opacity: .2;
    }

    .link:hover {
      stroke-opacity: .5;
    }
  </style>

  <h1 id="about">United States Graduate School Admissions</h1>
  <center><i>Manish Saha, Frank Rodriguez, Marcela Rey Rojas</i></center>
  <br>
  <div id="vis1About">
    <h2>How do test scores and GPA affect admission chance for foreign students?</h2>
    <p>
      In this visualization, we show how standardized test scores and college GPA influence one's admission chance in
      American graduate schools. While the <a href="https://www.kaptest.com/gre/what-is-the-gre">GRE</a> measures an
      applicant's overall readiness for graduate-level coursework, the <a
        href="https://www.ets.org/toefl/ibt/about">TOEFL</a> tests their English language ability. Chance of admit
      (ranging from ~0% to ~100%) is modeled with the size of each data point. <br><br>
      <i>Note: <a href="https://www.easycalculation.com/maths-dictionary/cgpa.html">CGPA</a> is the Cumulative Grade
        Point Average. To convert to a percentage, multiply the CGPA by 9.5.<br>(e.g. 10 CGPA = 10 * 9.5 = 95%)</i>
    </p>
  </div>
  <div id="vis1">
  </div>

  <br><br>

  <div id="vis2">
  </div>

  <script>
    const requestData = async () => {
      let universityData = await d3.csv('datasets/admissions.csv');
      let WIDTH = 1050;
      let HEIGHT = 700;
      let margin = { top: 20, left: 70, bottom: 50, right: 100 };
      let chartWidth = WIDTH - margin.left - margin.right;
      let chartHeight = HEIGHT - margin.top - margin.bottom;

      // cast string values to numbers
      universityData.forEach(d => {
        Object.keys(d).forEach(key => {
          d[key] = Number(d[key]);
          if (key === 'Chance of Admit')
            d[key] = d[key] * 10;
        });
      });

      // extract domains for relevant metrics
      let TOEFLMinMax = d3.extent(universityData, d => d['TOEFL Score']);
      let GREMinMax = d3.extent(universityData, d => d['GRE Score']);
      // add padding for domains
      TOEFLMinMax[0] -= 2;
      TOEFLMinMax[1] += 2;
      GREMinMax[0] -= 2;
      GREMinMax[1] += 2;
      const admitMinMax = d3.extent(universityData, d => d['Chance of Admit']);
      const CGPAMinMax = d3.extent(universityData, d => d['CGPA']);

      // SVG declaration
      testScoreSVG = d3.select('div#vis1').append("svg")
        .attr("width", WIDTH)
        .attr("height", HEIGHT)
        .attr("id", "testScoreSVG");

      admissionChance = d3.select('div#vis2').append("svg")
        .attr("width", 1300)
        .attr("height", 1300)
        .attr("id", "svgAdmissions")

      // scales
      let xScale = d3.scaleLinear()
        .domain(TOEFLMinMax)
        .range([0, chartWidth])
      let yScale = d3.scaleLinear()
        .domain(GREMinMax)
        .range([chartHeight, 0]);
      let rScale = d3.scaleLog()
        .domain(admitMinMax)
        .range([2, 12]);
      let colorScale = d3.scaleSequential(d3.interpolateBlues)
        .domain(CGPAMinMax)

      // gridlines (horizontal gridlines, vertical gridlines)
      let horizontalLines = d3.axisLeft(yScale).tickSize(-chartWidth - 10).ticks(10).tickFormat("");
      testScoreSVG.append("g").attr("class", "y gridlines")
        .attr("transform", "translate(" + (margin.left - 10) + "," + margin.top + ")")
        .call(horizontalLines);
      let verticalLines = d3.axisBottom(xScale).tickSize(-chartHeight - 10).ticks(12).tickFormat("");
      testScoreSVG.append("g").attr("class", "x gridlines")
        .attr("transform", "translate(" + margin.left + "," + (chartHeight + margin.top + 10) + ")")
        .call(verticalLines);

      // axes (y axis, x axis)
      testScoreSVG.append("g")
        .attr("transform", "translate(" + (margin.left - 10) + "," + margin.top + ")")
        .attr("class", "axis")
        .style("font-size", 12)
        .call(d3.axisLeft(yScale).ticks(10));
      testScoreSVG.append("g")
        .attr("transform", "translate(" + margin.left + "," + (chartHeight + margin.top + 10) + ")")
        .attr("class", "axis")
        .style("font-size", 12)
        .call(d3.axisBottom(xScale).ticks(12));

      // axis labels
      testScoreSVG.append("g")
        .attr("transform", "translate(" + (margin.left / 3) + "," + (margin.top + chartHeight / 2) + ")")
        .append("text")
        .attr("transform", "rotate(-90)")
        .text("GRE Score");
      testScoreSVG.append("g")
        .attr("transform", "translate(" + (margin.left + chartWidth / 2) + "," + (margin.top + chartHeight + margin.bottom) + ")")
        .append("text")
        .text("TOEFL Score");

      // data points
      let plot = testScoreSVG.append("g")
        .attr("transform", "translate(" + (margin.left + 0.5) + "," + margin.top + ")");
      universityData.forEach(d => {
        circle = plot.append("circle")
          .attr("cx", xScale(d["TOEFL Score"]))
          .attr("cy", yScale(d["GRE Score"]))
          .attr("r", rScale(d['Chance of Admit']))
          .style("fill", colorScale(d["CGPA"]))
          .attr("opacity", 0.8)
      });

      // linear gradient
      // https://www.visualcinnamon.com/2016/05/smooth-color-legend-d3-svg-gradient.html reference
      let gpaGradient = testScoreSVG.append('defs')
        .append('linearGradient')
        .attr('id', 'gpaGradient')
        .attr("x1", "0%")
        .attr("y1", "0%")
        .attr("x2", "0%")
        .attr("y2", "100%");
      gpaGradient.append('stop')
        .attr("stop-color", d3.schemeBlues[9][8])
        .attr('offset', '0%');
      gpaGradient.append('stop')
        .attr("stop-color", d3.schemeBlues[9][0])
        .attr('offset', '100%');
      // Use the gradient to set the shape fill
      plot.append('g')
        .attr('transform', 'translate(' + (chartWidth + 10) + ',0)')
        .append('rect')
        .attr("x", 0)
        .attr("y", 0)
        .attr('width', margin.right / 3)
        .attr('height', chartHeight)
        .style('fill', 'url(#gpaGradient');

      // linear gradient axis + label
      let gpaScale = d3.scaleLinear()
        .domain(colorScale.domain())
        .range([chartHeight, 0]);
      testScoreSVG.append("g")
        .attr("transform", "translate(" + (margin.left + chartWidth + margin.right / 2) + "," + margin.top + ")")
        .attr("class", "axis")
        .style("font-size", 12)
        .call(d3.axisRight(gpaScale).ticks(12));
      testScoreSVG.append("g")
        .attr("transform", "translate(" + (1.5 * margin.left + chartWidth + margin.right / 2) + "," + (margin.top + chartHeight / 2) + ")")
        .append("text")
        .attr("transform", "rotate(90)")
        .text("CGPA");

      WIDTH = 1300;
      HEIGHT = 1300;
      graduateDecisions = d3.select('div#vis2').append("svg")
        .attr("width", WIDTH)
        .attr("height", HEIGHT)
        .attr("id", "svgAdmissions");

      let gradData = await d3.csv('datasets/cornellAdmissions.csv');
      gradData = gradData.filter(d => (d.Accepted === 'Accepted' || d.Accepted === 'Rejected') && d.GPA <= 4.0);
      console.log(gradData);
      gradData.forEach(d => {
        d["GPA"] = Number(d["GPA"]);
        d["GRE_Verbal"] = Number(d["GRE_Verbal"]);
        d["GRE_Quant"] = Number(d["GRE_Quant"]);
        d["GRE_Writing"] = Number(d["GRE_Writing"])
      });
      let GPAMinMax = d3.extent(gradData, d => d.GPA);
      let GREQ = d3.extent(gradData, d => d.GRE_Quant);
      let GREV = d3.extent(gradData, d => d.GRE_Verbal);
      let GREW = d3.extent(gradData, d => d.GRE_Writing)
      gpaScale = d3.scaleLinear().domain(GPAMinMax).range([.1, 4]);
      let GREQScale = d3.scaleLinear().domain(GREQ).range([0.1, 3]);
      let GREVScale = d3.scaleLinear().domain(GREV).range([0.1, 3]);
      let GREWScale = d3.scaleLinear().domain(GREW).range([0.1, 3]);
      console.log(GPAMinMax, GREV, GREQ, GREW);


      margin = { top: 20, left: 70, bottom: 50, right: 100 };
      chartWidth = WIDTH - margin.left - margin.right;
      chartHeight = HEIGHT - margin.top - margin.bottom;

      // populate nodes
      let names = [
        "Cornell",
        "Yale",
        "Berkeley",
        "< 4",
        "< 3.75",
        "< 3.5",
        "< 3.25",
        "< 3",
        "< 2",
        "< 1",
        "High GRE Verbal",
        "Average GRE Verbal",
        "Low GRE Verbal",
        "High GRE Quant",
        "Average GRE Quant",
        "Low GRE Quant",
        "High GRE Writing",
        "Average GRE Writing",
        "Low GRE Writing",
        "Accepted",
        "Rejected",
      ];
      let nodes = [];
      let indexMapping = new Map(names.map((d, i) => [d, i]));
      names.forEach(d => nodes.push({ name: d }));

      // populate links
      links = [];
      gradData.forEach((d, i) => {
        let college = d.College;
        let fill = college === "Cornell" ? "red" : college === "Berkeley" ? "yellow" : "blue";
        let gpa = '< ';
        {{/* let gpa = '< ' + Math.ceil(gpaScale(d.GPA)); */}}
        const q = Math.ceil(GREQScale(d.GRE_Quant));
        let quant = (q == 1 ? 'Low ' : q == 2 ? 'Average ' : 'High ') + 'GRE Quant';
        const v = Math.ceil(GREVScale(d.GRE_Verbal));
        let verbal = (v == 1 ? 'Low ' : v == 2 ? 'Average ' : 'High ') + 'GRE Verbal';
        const w = Math.ceil(GREWScale(d.GRE_Writing));
        let writing = (w == 1 ? 'Low ' : w == 2 ? 'Average ' : 'High ') + 'GRE Writing';
        let decision = d.Accepted;

        if (d.GPA < 3.0) gpa += Math.ceil(gpaScale(d.GPA));
        else if (d.GPA < 3.25) gpa += '3.25';
        else if (d.GPA < 3.5) gpa += '3.5';
        else if (d.GPA < 3.75) gpa += '3.75';
        else if (d.GPA <= 4) gpa += '4';
        
        links.push(
          {
            source: indexMapping.get(college),
            target: indexMapping.get(gpa),
            value: i,
            color: fill,
          },
          {
            source: indexMapping.get(gpa),
            target: indexMapping.get(quant),
            value: i,
            color: fill,
          },
          {
            source: indexMapping.get(quant),
            target: indexMapping.get(verbal),
            value: i,
            color: fill,
          },
          {
            source: indexMapping.get(verbal),
            target: indexMapping.get(writing),
            value: i,
            color: fill,
          },
          {
            source: indexMapping.get(writing),
            target: indexMapping.get(decision),
            value: i,
            color: fill
          });
      });

      const sankey = d3.sankey()
        .nodeWidth(36)
        .nodePadding(10)
        .extent([[20, 20], [1200 - 1, 600 - 5]]);

      console.log(links);
      let graph = sankey({ nodes, links })

      const color = d3.scaleOrdinal(d3.schemeCategory10);
      let idx = 0;
      const calcColor = () => {
        return color(idx++);
      }
      graduateDecisions.append("g")
        .attr("stroke", "#000")
        .selectAll("rect")
        .data(graph.nodes)
        .join("rect")
        .attr("x", d => d.x0)
        .attr("y", d => d.y0)
        .attr("height", d => (d.y1 - d.y0))
        .attr("width", d => d.x1 - d.x0)
        .attr("fill", d => calcColor())
        .append("title")
        .text(d => d.name)

      console.log(links)
      graduateDecisions.append("g")
        .attr("fill", "none")
        .attr("stroke-opacity", .6)
        .selectAll("path")
        .data(graph.links)
        .join("path")
        .attr("stroke", d => d.color)
        .attr("d", d3.sankeyLinkHorizontal())

      graduateDecisions.append("g")
        .style("font", "10px sans-serif")
        .selectAll("text")
        .data(nodes)
        .join("text")
        .attr("x", d => d.x0 < WIDTH / 2 ? d.x1 + 6 : d.x0 - 6)
        .attr("y", d => (d.y1 + d.y0) / 2)
        .attr("text-anchor", d => d.x0 < WIDTH / 2 ? "start" : "end")
        .text(d => d.name);
    }

    /* columns: (9) ["Serial No.", "GRE Score", "TOEFL Score", "University Rating", "SOP", "LOR ", "CGPA", "Research", "Chance of Admit "] */
    requestData();
  </script>
</body>