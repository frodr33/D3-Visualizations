<head>
    <script src="https://unpkg.com/d3-array@1"></script>
    <script src="https://unpkg.com/d3-collection@1"></script>
    <script src="https://unpkg.com/d3-path@1"></script>
    <script src="https://unpkg.com/d3-shape@1"></script>
    <script src="https://unpkg.com/d3-sankey@0"></script>
    <script src="https://d3js.org/d3.v5.min.js"></script>
</head>

<body>
  <style>
    .center {
      text-align: center;
      font-family: Verdana;
    }

    .vis {
      display: inline-block;
    }

    /* .line {
          stroke: gray;
      } */
    .gridlines line {
      stroke: gray;
    }

    .gridlines .domain {
      stroke: none;
    }
  </style>

  <h2 class="center">U.S. Graduate Admissions</h2>

  <div class="vis" id="vis1">
  </div>

  <div class="vis" id="vis2">
  </div>

  <script>
    const requestData = async () => {
      let universityData = await d3.csv("datasets/admissions.csv");
      const WIDTH = 800;
      const HEIGHT = 600;
      const margin = { top: 20, left: 20, bottom: 20, right: 20 };
      const chartWidth = WIDTH - margin.left - margin.right;
      const chartHeight = HEIGHT - margin.top - margin.bottom;

      // Cast string values to numbers
      universityData.forEach(d => {
        Object.keys(d).forEach(field => {
          d[field] = Number(d[field])
        });
      });

      const TOEFLmin = d3.min(universityData, d => d['TOEFL Score']);
      const TOEFLmax = d3.max(universityData, d => d['TOEFL Score']);
      const GREmin = d3.min(universityData, d => d['GRE Score']);
      const GREmax = d3.max(universityData, d => d['GRE Score']);
      const admitMin = d3.min(universityData, d => d['Chance of Admit'] * 10);
      const admitMax = d3.max(universityData, d => d['Chance of Admit'] * 10);
      console.log(admitMin, admitMax);
      console.log(universityData);
      console.log(TOEFLmin, TOEFLmax);

      // Set up svgs...we could add a third one?
      testScores = d3.select('div#vis1').append("svg")
        .attr("width", WIDTH)
        .attr("height", HEIGHT)
        .attr("id", "svgTestScores");

      admissionChance = d3.select('div#vis2').append("svg")
        .attr("width", WIDTH)
        .attr("height", HEIGHT)
        .attr("id", "svgAdmissions");

      // axes
      let xScale = d3.scaleLinear()
        .domain([TOEFLmin - 2, TOEFLmax])
        .range([margin.left, WIDTH - margin.right])

      let yScale = d3.scaleLinear()
        .domain([GREmin - 5, GREmax + 5])
        .range([HEIGHT - margin.top, margin.bottom]);

      let rScale = d3.scaleLog()
        .domain([admitMin, admitMax])
        .range([1, 12]);

      // axes and gridlines
      let xAxis = d3.axisLeft(yScale).tickSize(-chartWidth).tickFormat("").ticks(12);
      testScores.append("g").attr("class", "y gridlines")
        .attr("transform", "translate(30,0)")
        .call(xAxis);

      let yAxis = d3.axisBottom(xScale).tickSize(-chartHeight).tickFormat("").ticks(12);
      testScores.append("g")
        .attr("transform", "translate(10," + yScale(GREmin - 5) + ")")
        .attr("class", "x gridlines")
        .call(yAxis);

      testScores.append("g")
        .attr("transform", "translate(10," + yScale(GREmin - 5) + ")")
        .attr("class", "axis")
        .call(d3.axisBottom(xScale).ticks(12));

      testScores.append("g")
        .attr("transform", "translate(30,0)")
        .attr("class", "axis")
        .call(d3.axisLeft(yScale).ticks(12));

      universityData.forEach((d, i) => {
        circle = testScores.append("circle")
          .attr("cx", xScale(d["TOEFL Score"]))
          .attr("cy", yScale(d["GRE Score"]))
          .attr("r", rScale(d['Chance of Admit'] * 10))
          .style("fill", "blue") // change this too
          .attr("opacity", 0.3)
      });


      //////////////////////////////////////// 
      /////////////    svg2    /////////////// 
      //////////////////////////////////////// 

      var cornellData = await d3.csv("datasets/cornellAdmissions.csv");

      cornellData.forEach((d) => {
          if (d["Rejected"] != "Rejected" && d["Rejected"] != "Accepted"){
              d["Rejected"] = "Rejected" 
          }
      });


      const nodeNames = ["Cornell", "High GPA", "Average GPA", "Low GPA", "Accepted", "Rejected"];
      let indexMapping = new Map(nodeNames.map((d,i) => [d,i]));
      {{/* console.log("here")
      console.log(indexMapping); */}}
      let nodes = [];
      nodeNames.forEach((nodeName) => {
          nodes.push({name:nodeName});
      })

      // First add connections between cornell and rejected
      let links = [];
      cornellData.forEach((d) => {
          links.push({
              source: indexMapping.get("Cornell"),
              target: indexMapping.get(d["Rejected"]),
              value: 25
          });
      });
    
      const sankey = d3.sankey()
        .nodeWidth(15)
        .nodePadding(10)
        .extent([[1, 1], [600 - 1, 800 - 5]]);
    
      graph = sankey({nodes, links})
      {{/* admissionChance.append("g")
        .attr("stroke","#000")
        .selectAll("rect")
        .data(graph.nodes)
        .join("rect")
        .attr("x", d => d.x0)
        .attr("y", d => d,y0)
        .attr("height", d => d.y1 - d.y0)
        .attr("width", d => d.x1 - d.x0)
        .append("title")
            .text(d => ) */}}
      
      




      {{/* var link = admissionChance.append("g").selectAll(".link")
        .data(links)
        .enter().append("path")
        .attr("class","link")
        .attr("d",path)
        .style("stroke-width", 1)


      var node = admissionChance.append("g").selectAll(".node")
        .data(nodes)
        .enter().append("g")
        .attr("class","node")
        .attr("transform", (d) => {
            return "translate(" + d.x + "," + d.y + ")";}) */}}
    }

    { {/* columns: (9) ["Serial No.", "GRE Score", "TOEFL Score", "University Rating", "SOP", "LOR ", "CGPA", "Research", "Chance of Admit "] */ } }
    requestData();
  </script>
</body>